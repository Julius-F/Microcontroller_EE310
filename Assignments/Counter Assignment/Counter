; Title: Counter
;---------------------
; Program Details:
;
; Description: Count up on a seven segment display when a button is pressed
; count down when a different button is pressed
; reset to zero when both are pressed
; File Dependencies / Libraries: None 
; Compiler: xc8, 2.4
; Author: Julius Faller
; Inputs: PORTB
; Outputs: PORTD
; Versions:
;       V1.0 3/26/24


;---------------------
; Initialization
;---------------------
#include "C:\Users\jmelf\MPLABXProjects\Counter.X\AssemblyConfig.inc"
#include <xc.inc>



;---------------------
; Program Inputs
;---------------------

    
;---------------------
; Definitions
;---------------------

    ; codenames for some definitions because mplab doesnt like using zero
    ; or letters for variable names
    ZULU	EQU 00000001    
    ONE		EQU 01101101
    TWO		EQU 00100010
    THREE	EQU 10000010
    FOUR	EQU 11000100
    FIVE	EQU 10001000
    SIX		EQU 00001000
    SEVEN	EQU 11000011
    EIGHT	EQU 00000000
    NINE	EQU 11000000
    ALPHA	EQU 01000000
    BRAVO	EQU 00001100
    CHARLIE	EQU 00101001
    DELTA	EQU 00000110
    ECHO	EQU 00101000
    FOXTROT	EQU 01101000
    
;---------------------
; Program Constants
;---------------------
    
    COUNTERTRACK    EQU 0X31
    INNERLOOP	    EQU	0X32	
    OUTERLOOP	    EQU	0X33


    

;---------------------
; Main Program
;---------------------

 PSECT absdata,abs,ovrld
    ; Start program at 0x20
    ORG 0020H 
    CALL    STARTUP
    
TESTBUTTONS:
    MOVLW   0X03    ; to check if both are pressed
    CPFSEQ  PORTB
    GOTO    CHECKDOWN
    CALL    RESETCOUNTER
    GOTO    ENDCHECK
CHECKDOWN:
    MOVLW   0X02
    CPFSEQ  PORTB
    GOTO    CHECKUP
    CALL    COUNTDOWN
    GOTO    ENDCHECK
CHECKUP:
    MOVLW   0X01
    CPFSEQ  PORTB
    GOTO    ENDCHECK
    CALL    COUNTUP
ENDCHECK:
    CALL    DELAY
    GOTO    TESTBUTTONS
    
RESETCOUNTER:
    LFSR    1,0X40
    MOVFF   INDF1,WREG
    MOVWF   PORTD
    MOVLW   0X01
    MOVWF   COUNTERTRACK
    RETURN
    
COUNTDOWN:
    DECFSZ  COUNTERTRACK,1
    GOTO    REGDOWN
    GOTO    BACKTOTOP    
REGDOWN:    
    MOVFF   POSTDEC1,WREG
    MOVFF   INDF1,WREG
    MOVWF   PORTD
    RETURN
BACKTOTOP:
    LFSR    1,0X004F
    MOVFF   INDF1,WREG
    MOVLW   0X10
    MOVWF   COUNTERTRACK
    RETURN
    
COUNTUP:    
    INCF    COUNTERTRACK,1
    MOVLW   0X10
    CPFSGT  COUNTERTRACK
    GOTO    REGUP
    GOTO    BACKTOBOT
    
REGUP:
    MOVFF   PREINC1,WREG
    MOVWF   PORTD
    RETURN
BACKTOBOT: 
    MOVLW   0X01
    MOVWF   COUNTERTRACK
    LFSR    1,0X0040
    MOVFF   INDF1,WREG
    MOVWF   PORTD
    RETURN
    
STARTUP:

    BANKSEL	PORTD 
    CLRF	PORTD	;initialize PORTA
    BANKSEL	LATD	;data Latch
    CLRF	LATD 
    BANKSEL	ANSELD 
    CLRF	ANSELD	;digital I/O
    BANKSEL	TRISD 
    MOVLW	0X00 
    MOVWF	TRISD 
    
        BANKSEL	PORTB 
    CLRF	PORTB	;initialize PORTB
    BANKSEL	LATB	;data Latch
    CLRF	LATB 
    BANKSEL	ANSELB 
    CLRF	ANSELB	;digital I/O
    BANKSEL	TRISB 
    MOVLW	0XFF	;port b is an input
    MOVWF	TRISB    
    LFSR	1,0X40	;initialize pointer
    ; set values for zero through f on seven segment
    MOVLW   ZULU
    MOVWF   POSTINC1
    MOVLW   ONE
    MOVWF   POSTINC1
    MOVLW   TWO
    MOVWF   POSTINC1
    MOVLW   THREE
    MOVWF   POSTINC1
    MOVLW   FOUR
    MOVWF   POSTINC1
    MOVLW   FIVE
    MOVWF   POSTINC1
    MOVLW   SIX
    MOVWF   POSTINC1
    MOVLW   SEVEN
    MOVWF   POSTINC1
    MOVLW   EIGHT
    MOVWF   POSTINC1
    MOVLW   NINE
    MOVWF   POSTINC1
    MOVLW   ALPHA
    MOVWF   POSTINC1
    MOVLW   BRAVO
    MOVWF   POSTINC1
    MOVLW   CHARLIE
    MOVWF   POSTINC1
    MOVLW   DELTA
    MOVWF   POSTINC1
    MOVLW   ECHO
    MOVWF   POSTINC1
    MOVLW   FOXTROT
    MOVWF   POSTINC1
    LFSR    1,0X0040
    MOVFF   INDF1,PORTD
    ;create counter to keep track of resets
    MOVLW   0X01
    MOVWF   COUNTERTRACK
    RETURN
DELAY:
    
    MOVLW   0XFF
    MOVWF   OUTERLOOP
    MOVWF   INNERLOOP
    
LOOP:
    DECF    INNERLOOP,1
    BNZ	    LOOP
    MOVLW   0XFF
    MOVWF   INNERLOOP
    DECF    OUTERLOOP,1
    BNZ	    LOOP
    RETURN
    


